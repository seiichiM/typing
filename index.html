<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Master 2000</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --text-color: #e0e0e0;
            --accent-color: #0f3460;
            --highlight-color: #e94560;
            --correct-color: #4caf50;
            --font-main: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .container {
            text-align: center;
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }

        /* Screens */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Elements */
        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: var(--highlight-color);
        }

        button {
            background-color: var(--highlight-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.1s, box-shadow 0.1s;
            margin-top: 20px;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--highlight-color);
        }

        button:active {
            transform: scale(0.95);
        }

        /* Game Display */
        .status-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.5rem;
            margin-bottom: 40px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .word-container {
            margin: 40px 0;
            position: relative;
        }

        .kanji {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 10px;
            min-height: 1.2em;
        }

        .kana {
            font-size: 1.5rem;
            color: #aaa;
            margin-bottom: 5px;
            min-height: 1.2em;
        }

        .romaji {
            font-size: 2.5rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            color: #666;
            position: relative;
        }

        .romaji span.typed {
            color: var(--correct-color);
            text-shadow: 0 0 5px var(--correct-color);
        }

        .romaji span.current {
            border-bottom: 3px solid var(--highlight-color);
        }

        .romaji span.error {
            color: red;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Ranking */
        .ranking-list {
            list-style: none;
            padding: 0;
            width: 80%;
            margin: 20px auto;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 1.1rem;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-rank {
            font-weight: bold;
            color: var(--highlight-color);
            width: 30px;
        }

        .input-group {
            margin-top: 20px;
        }
        
        input[type="text"] {
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: none;
            outline: none;
            text-align: center;
        }

        /* Keyboard hint (optional) */
        .keyboard-hint {
            margin-top: 50px;
            font-size: 0.9rem;
            color: #555;
        }

    </style>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</head>
<body>

<div class="container">
    <!-- Start Screen -->
    <div id="start-screen" class="screen active">
        <h1>TYPING MASTER</h1>
        <p>Limit: 60 Seconds / Word Set: Common Japanese (Top 2000 rules applied)</p>
        <button id="start-btn">GAME START</button>
        <div class="ranking-list" id="top-ranking">
            <!-- Ranking populated by JS -->
            <p>Loading ranking...</p>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="status-bar">
            <div id="timer">Time: 90</div>
            <div id="score">Score: 0</div>
        </div>
        
        <div class="word-container">
            <div id="display-kanji" class="kanji"></div>
            <div id="display-kana" class="kana"></div>
            <div id="display-romaji" class="romaji"></div>
        </div>

        <div class="keyboard-hint">Type the Romaji exactly as shown</div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="screen">
        <h1>TIME UP!</h1>
        <h2>Final Score: <span id="final-score">0</span></h2>
        
        <div class="status-details" style="margin-bottom: 20px; font-size: 0.9rem; color: #aaa;">
            Correct: <span id="res-correct">0</span> chars / 
            Miss: <span id="res-miss">0</span> / 
            WPM: <span id="res-wpm">0</span>
        </div>

        <div id="new-record-form" class="input-group" style="display:none;">
            <p style="color: var(--correct-color);">‚òÖ NEW RECORD! ‚òÖ</p>
            <input type="text" id="player-name" placeholder="Enter Name (max 10)" maxlength="10">
            <button id="save-rank-btn">Save Score</button>
        </div>
        
        <button id="retry-btn">Try Again</button>
        <button id="home-btn" style="background-color: #555;">Back to Title</button>
    </div>
</div>

<script>
    /**
     * ÂçòË™û„É™„Çπ„Éà
     * JLPT N5-N3„É¨„Éô„É´„ÅÆÈ†ªÂá∫ÂçòË™û„Çí‰∏≠ÂøÉ„Å´„ÄÅË§áÊï∞„ÅÆ„Éá„Éº„Çø„Éô„Éº„Çπ(BCCWJ, WikipediaÁ≠â)„Åß
     * ‰∏ä‰Ωç„Å´„É©„É≥„ÇØ„Ç§„É≥„Åô„Çã„Åß„ÅÇ„Çç„ÅÜÂçòË™û„ÇíÂé≥ÈÅ∏„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
     * „Åì„Åì„Å´2000Ë™û„Åæ„ÅßËøΩÂä†ÂèØËÉΩ„Åß„Åô„ÄÇ
     */
    const wordList = [
        // Greetings & Basics
        { word: "„Åì„Çì„Å´„Å°„ÅØ", kana: "„Åì„Çì„Å´„Å°„ÅØ", romaji: "konnichiwa" },
        { word: "„ÅÇ„Çä„Åå„Å®„ÅÜ", kana: "„ÅÇ„Çä„Åå„Å®„ÅÜ", romaji: "arigatou" },
        { word: "„Åô„Åø„Åæ„Åõ„Çì", kana: "„Åô„Åø„Åæ„Åõ„Çì", romaji: "sumimasen" },
        { word: "„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", kana: "„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô", romaji: "onegaishimasu" },
        { word: "ÁßÅ„ÅØ", kana: "„Çè„Åü„Åó„ÅØ", romaji: "watashiha" },
        { word: "Êó•Êú¨", kana: "„Å´„Åª„Çì", romaji: "nihon" },
        { word: "Â≠¶Áîü", kana: "„Åå„Åè„Åõ„ÅÑ", romaji: "gakusei" },
        { word: "ÂÖàÁîü", kana: "„Åõ„Çì„Åõ„ÅÑ", romaji: "sensei" },
        
        // Verbs (Basic)
        { word: "È£ü„Åπ„Çã", kana: "„Åü„Åπ„Çã", romaji: "taberu" },
        { word: "È£≤„ÇÄ", kana: "„ÅÆ„ÇÄ", romaji: "nomu" },
        { word: "Ë¶ã„Çã", kana: "„Åø„Çã", romaji: "miru" },
        { word: "ËÅû„Åè", kana: "„Åç„Åè", romaji: "kiku" },
        { word: "Ë°å„Åè", kana: "„ÅÑ„Åè", romaji: "iku" },
        { word: "Êù•„Çã", kana: "„Åè„Çã", romaji: "kuru" },
        { word: "Ë©±„Åô", kana: "„ÅØ„Å™„Åô", romaji: "hanasu" },
        { word: "Êõ∏„Åè", kana: "„Åã„Åè", romaji: "kaku" },
        { word: "Ë™≠„ÇÄ", kana: "„Çà„ÇÄ", romaji: "yomu" },
        { word: "Ë≤∑„ÅÜ", kana: "„Åã„ÅÜ", romaji: "kau" },
        { word: "ÂãâÂº∑", kana: "„Åπ„Çì„Åç„Çá„ÅÜ", romaji: "benkyou" },
        { word: "ÂÉç„Åè", kana: "„ÅØ„Åü„Çâ„Åè", romaji: "hataraku" },
        { word: "ÈÅä„Å∂", kana: "„ÅÇ„Åù„Å∂", romaji: "asobu" },
        { word: "ÂØù„Çã", kana: "„Å≠„Çã", romaji: "neru" },
        { word: "Ëµ∑„Åç„Çã", kana: "„Åä„Åç„Çã", romaji: "okiru" },
        { word: "‰ºö„ÅÜ", kana: "„ÅÇ„ÅÜ", romaji: "au" },
        { word: "Ê≠©„Åè", kana: "„ÅÇ„Çã„Åè", romaji: "aruku" },
        { word: "Ëµ∞„Çã", kana: "„ÅØ„Åó„Çã", romaji: "hashiru" },
        { word: "Ê≥≥„Åê", kana: "„Åä„Çà„Åê", romaji: "oyogu" },
        { word: "Ê≠å„ÅÜ", kana: "„ÅÜ„Åü„ÅÜ", romaji: "utau" },
        { word: "Â∏∞„Çã", kana: "„Åã„Åà„Çã", romaji: "kaeru" },
        { word: "ÂæÖ„Å§", kana: "„Åæ„Å§", romaji: "matsu" },
        { word: "ÊåÅ„Å§", kana: "„ÇÇ„Å§", romaji: "motsu" },
        { word: "Âèñ„Çã", kana: "„Å®„Çã", romaji: "toru" },
        { word: "Êâã‰ºù„ÅÜ", kana: "„Å¶„Å§„Å†„ÅÜ", romaji: "tetsudau" },
        { word: "Âëº„Å∂", kana: "„Çà„Å∂", romaji: "yobu" },
        { word: "Êïô„Åà„Çã", kana: "„Åä„Åó„Åà„Çã", romaji: "oshieru" },
        { word: "Ë¶ö„Åà„Çã", kana: "„Åä„Åº„Åà„Çã", romaji: "oboeru" },
        { word: "Âøò„Çå„Çã", kana: "„Çè„Åô„Çå„Çã", romaji: "wasureru" },
        { word: "ËÄÉ„Åà„Çã", kana: "„Åã„Çì„Åå„Åà„Çã", romaji: "kangaeru" },
        { word: "Ê±∫„ÇÅ„Çã", kana: "„Åç„ÇÅ„Çã", romaji: "kimeru" },
        { word: "ÂàÜ„Åã„Çã", kana: "„Çè„Åã„Çã", romaji: "wakaru" },
        { word: "‰Ωè„ÇÄ", kana: "„Åô„ÇÄ", romaji: "sumu" },
        { word: "Â∫ß„Çã", kana: "„Åô„Çè„Çã", romaji: "suwaru" },
        { word: "Á´ã„Å§", kana: "„Åü„Å§", romaji: "tatsu" },
        { word: "Âá∫„Åô", kana: "„Å†„Åô", romaji: "dasu" },
        { word: "ÂÖ•„Çã", kana: "„ÅØ„ÅÑ„Çã", romaji: "hairu" },
        { word: "‰πó„Çã", kana: "„ÅÆ„Çã", romaji: "noru" },
        { word: "Èôç„Çä„Çã", kana: "„Åä„Çä„Çã", romaji: "oriru" },
        { word: "Èñã„Åë„Çã", kana: "„ÅÇ„Åë„Çã", romaji: "akeru" },
        { word: "Èñâ„ÇÅ„Çã", kana: "„Åó„ÇÅ„Çã", romaji: "shimeru" },
        { word: "Ê∂à„Åô", kana: "„Åë„Åô", romaji: "kesu" },
        { word: "„Å§„Åë„Çã", kana: "„Å§„Åë„Çã", romaji: "tsukeru" },
        { word: "‰Ωú„Çã", kana: "„Å§„Åè„Çã", romaji: "tsukuru" },
        { word: "‰Ωø„ÅÜ", kana: "„Å§„Åã„ÅÜ", romaji: "tsukau" },
        { word: "ÈÄÅ„Çã", kana: "„Åä„Åè„Çã", romaji: "okuru" },
        { word: "Ê≠ª„Å¨", kana: "„Åó„Å¨", romaji: "shinu" },
        { word: "ÊÄ•„Åê", kana: "„ÅÑ„Åù„Åê", romaji: "isogu" },
        { word: "ÈÅ∏„Å∂", kana: "„Åà„Çâ„Å∂", romaji: "erabu" },
        { word: "Âñú„Å∂", kana: "„Çà„Çç„Åì„Å∂", romaji: "yorokobu" },
        { word: "Âõ∞„Çã", kana: "„Åì„Åæ„Çã", romaji: "komaru" },
        { word: "ÊÄí„Çã", kana: "„Åä„Åì„Çã", romaji: "okoru" },
        { word: "Á¨ë„ÅÜ", kana: "„Çè„Çâ„ÅÜ", romaji: "warau" },
        { word: "Ê≥£„Åè", kana: "„Å™„Åè", romaji: "naku" },
        { word: "ÁùÄ„Çã", kana: "„Åç„Çã", romaji: "kiru" },
        { word: "ËÑ±„Åê", kana: "„Å¨„Åê", romaji: "nugu" },
        { word: "Ë≤∏„Åô", kana: "„Åã„Åô", romaji: "kasu" },
        { word: "ÂÄü„Çä„Çã", kana: "„Åã„Çä„Çã", romaji: "kariru" },
        { word: "Ëøî„Åô", kana: "„Åã„Åà„Åô", romaji: "kaesu" },
        { word: "Âàá„Çã", kana: "„Åç„Çã", romaji: "kiru" },
        { word: "Â£≤„Çã", kana: "„ÅÜ„Çã", romaji: "uru" },
        { word: "Êâï„ÅÜ", kana: "„ÅØ„Çâ„ÅÜ", romaji: "harau" },
        { word: "Êé¢„Åô", kana: "„Åï„Åå„Åô", romaji: "sagasu" },
        { word: "Ê≠¢„Åæ„Çã", kana: "„Å®„Åæ„Çã", romaji: "tomaru" },
        { word: "Êõ≤„Åå„Çã", kana: "„Åæ„Åå„Çã", romaji: "magaru" },
        { word: "Ê∏°„Çã", kana: "„Çè„Åü„Çã", romaji: "wataru" },
        { word: "Êô¥„Çå„Çã", kana: "„ÅØ„Çå„Çã", romaji: "hareru" },
        { word: "Êõá„Çã", kana: "„Åè„ÇÇ„Çã", romaji: "kumoru" },
        { word: "Âêπ„Åè", kana: "„Åµ„Åè", romaji: "fuku" },
        { word: "Èôç„Çã", kana: "„Åµ„Çã", romaji: "furu" },
        { word: "È£õ„Å∂", kana: "„Å®„Å∂", romaji: "tobu" },
        { word: "È≥¥„Åè", kana: "„Å™„Åè", romaji: "naku" },
        { word: "Âí≤„Åè", kana: "„Åï„Åè", romaji: "saku" },
        { word: "Âßã„Åæ„Çã", kana: "„ÅØ„Åò„Åæ„Çã", romaji: "hajimaru" },
        { word: "ÁµÇ„Çè„Çã", kana: "„Åä„Çè„Çã", romaji: "owaru" },
        { word: "Á∂ö„Åè", kana: "„Å§„Å•„Åè", romaji: "tsuzuku" },
        { word: "Â§â„Çè„Çã", kana: "„Åã„Çè„Çã", romaji: "kawaru" },
        { word: "Â¢ó„Åà„Çã", kana: "„Åµ„Åà„Çã", romaji: "fueru" },
        { word: "Ê∏õ„Çã", kana: "„Å∏„Çã", romaji: "heru" },

        // Adjectives
        { word: "Â§ß„Åç„ÅÑ", kana: "„Åä„Åä„Åç„ÅÑ", romaji: "ookii" },
        { word: "Â∞è„Åï„ÅÑ", kana: "„Å°„ÅÑ„Åï„ÅÑ", romaji: "chiisai" },
        { word: "È´ò„ÅÑ", kana: "„Åü„Åã„ÅÑ", romaji: "takai" },
        { word: "ÂÆâ„ÅÑ", kana: "„ÇÑ„Åô„ÅÑ", romaji: "yasui" },
        { word: "Êñ∞„Åó„ÅÑ", kana: "„ÅÇ„Åü„Çâ„Åó„ÅÑ", romaji: "atarashii" },
        { word: "Âè§„ÅÑ", kana: "„Åµ„Çã„ÅÑ", romaji: "furui" },
        { word: "ËâØ„ÅÑ", kana: "„ÅÑ„ÅÑ", romaji: "ii" },
        { word: "ÊÇ™„ÅÑ", kana: "„Çè„Çã„ÅÑ", romaji: "warui" },
        { word: "Êöë„ÅÑ", kana: "„ÅÇ„Å§„ÅÑ", romaji: "atsui" },
        { word: "ÂØí„ÅÑ", kana: "„Åï„ÇÄ„ÅÑ", romaji: "samui" },
        { word: "Èõ£„Åó„ÅÑ", kana: "„ÇÄ„Åö„Åã„Åó„ÅÑ", romaji: "muzukashii" },
        { word: "Á∞°Âçò", kana: "„Åã„Çì„Åü„Çì", romaji: "kantan" },
        { word: "Â•Ω„Åç", kana: "„Åô„Åç", romaji: "suki" },
        { word: "Â´å„ÅÑ", kana: "„Åç„Çâ„ÅÑ", romaji: "kirai" },
        { word: "Áæé„Åó„ÅÑ", kana: "„ÅÜ„Å§„Åè„Åó„ÅÑ", romaji: "utsukushii" },
        { word: "Ê•Ω„Åó„ÅÑ", kana: "„Åü„ÅÆ„Åó„ÅÑ", romaji: "tanoshii" },
        { word: "Èù¢ÁôΩ„ÅÑ", kana: "„Åä„ÇÇ„Åó„Çç„ÅÑ", romaji: "omoshiroi" },
        { word: "„Å§„Åæ„Çâ„Å™„ÅÑ", kana: "„Å§„Åæ„Çâ„Å™„ÅÑ", romaji: "tsumaranai" },
        { word: "Âøô„Åó„ÅÑ", kana: "„ÅÑ„Åù„Åå„Åó„ÅÑ", romaji: "isogashii" },
        { word: "Êöá", kana: "„Å≤„Åæ", romaji: "hima" },
        { word: "Ëøë„ÅÑ", kana: "„Å°„Åã„ÅÑ", romaji: "chikai" },
        { word: "ÈÅ†„ÅÑ", kana: "„Å®„Åä„ÅÑ", romaji: "tooi" },
        { word: "Êó©„ÅÑ", kana: "„ÅØ„ÇÑ„ÅÑ", romaji: "hayai" },
        { word: "ÈÅÖ„ÅÑ", kana: "„Åä„Åù„ÅÑ", romaji: "osoi" },
        { word: "Â§ö„ÅÑ", kana: "„Åä„Åä„ÅÑ", romaji: "ooi" },
        { word: "Â∞ë„Å™„ÅÑ", kana: "„Åô„Åè„Å™„ÅÑ", romaji: "sukunai" },
        { word: "Êöñ„Åã„ÅÑ", kana: "„ÅÇ„Åü„Åü„Åã„ÅÑ", romaji: "atatakai" },
        { word: "Ê∂º„Åó„ÅÑ", kana: "„Åô„Åö„Åó„ÅÑ", romaji: "suzushii" },
        { word: "Áîò„ÅÑ", kana: "„ÅÇ„Åæ„ÅÑ", romaji: "amai" },
        { word: "Ëæõ„ÅÑ", kana: "„Åã„Çâ„ÅÑ", romaji: "karai" },
        { word: "Ëã¶„ÅÑ", kana: "„Å´„Åå„ÅÑ", romaji: "nigai" },
        { word: "Èáç„ÅÑ", kana: "„Åä„ÇÇ„ÅÑ", romaji: "omoi" },
        { word: "ËªΩ„ÅÑ", kana: "„Åã„Çã„ÅÑ", romaji: "karui" },
        { word: "Â∫É„ÅÑ", kana: "„Å≤„Çç„ÅÑ", romaji: "hiroi" },
        { word: "Áã≠„ÅÑ", kana: "„Åõ„Åæ„ÅÑ", romaji: "semai" },
        { word: "Âº∑„ÅÑ", kana: "„Å§„Çà„ÅÑ", romaji: "tsuyoi" },
        { word: "Âº±„ÅÑ", kana: "„Çà„Çè„ÅÑ", romaji: "yowai" },
        { word: "Êöó„ÅÑ", kana: "„Åè„Çâ„ÅÑ", romaji: "kurai" },
        { word: "Êòé„Çã„ÅÑ", kana: "„ÅÇ„Åã„Çã„ÅÑ", romaji: "akarui" },
        { word: "Áóõ„ÅÑ", kana: "„ÅÑ„Åü„ÅÑ", romaji: "itai" },
        { word: "Áú†„ÅÑ", kana: "„Å≠„ÇÄ„ÅÑ", romaji: "nemui" },
        { word: "ÊÄñ„ÅÑ", kana: "„Åì„Çè„ÅÑ", romaji: "kowai" },
        { word: "ÊÅ•„Åö„Åã„Åó„ÅÑ", kana: "„ÅØ„Åö„Åã„Åó„ÅÑ", romaji: "hazukashii" },
        { word: "Ê≠£„Åó„ÅÑ", kana: "„Åü„Å†„Åó„ÅÑ", romaji: "tadashii" },
        { word: "„Åô„Åî„ÅÑ", kana: "„Åô„Åî„ÅÑ", romaji: "sugoi" },
        { word: "Á¥†Êô¥„Çâ„Åó„ÅÑ", kana: "„Åô„Å∞„Çâ„Åó„ÅÑ", romaji: "subarashii" },
        { word: "Â§ßÂàá", kana: "„Åü„ÅÑ„Åõ„Å§", romaji: "taisetsu" },
        { word: "‰æøÂà©", kana: "„Åπ„Çì„Çä", romaji: "benri" },
        { word: "‰∏ç‰æø", kana: "„Åµ„Åπ„Çì", romaji: "fuben" },
        { word: "ÂÖÉÊ∞ó", kana: "„Åí„Çì„Åç", romaji: "genki" },
        { word: "Ë¶™Âàá", kana: "„Åó„Çì„Åõ„Å§", romaji: "shinsetsu" },
        { word: "ÊúâÂêç", kana: "„ÇÜ„ÅÜ„ÇÅ„ÅÑ", romaji: "yuumei" },
        { word: "Èùô„Åã", kana: "„Åó„Åö„Åã", romaji: "shizuka" },
        { word: "„Åç„Çå„ÅÑ", kana: "„Åç„Çå„ÅÑ", romaji: "kirei" },
        { word: "ÂÆâÂÖ®", kana: "„ÅÇ„Çì„Åú„Çì", romaji: "anzen" },
        { word: "Âç±Èô∫", kana: "„Åç„Åë„Çì", romaji: "kiken" },

        // Nouns - Daily Life
        { word: "ÊôÇÈñì", kana: "„Åò„Åã„Çì", romaji: "jikan" },
        { word: "ÈõªË©±", kana: "„Åß„Çì„Çè", romaji: "denwa" },
        { word: "ÈõªËªä", kana: "„Åß„Çì„Åó„ÇÉ", romaji: "densha" },
        { word: "Ëªä", kana: "„Åè„Çã„Åæ", romaji: "kuruma" },
        { word: "ÈÉ®Â±ã", kana: "„Å∏„ÇÑ", romaji: "heya" },
        { word: "ÂÆ∂", kana: "„ÅÑ„Åà", romaji: "ie" },
        { word: "Â≠¶Ê†°", kana: "„Åå„Å£„Åì„ÅÜ", romaji: "gakkou" },
        { word: "‰ºöÁ§æ", kana: "„Åã„ÅÑ„Åó„ÇÉ", romaji: "kaisha" },
        { word: "‰ªï‰∫ã", kana: "„Åó„Åî„Å®", romaji: "shigoto" },
        { word: "ÂèãÈÅî", kana: "„Å®„ÇÇ„Å†„Å°", romaji: "tomodachi" },
        { word: "ÂÆ∂Êóè", kana: "„Åã„Åû„Åè", romaji: "kazoku" },
        { word: "‰ªäÊó•", kana: "„Åç„Çá„ÅÜ", romaji: "kyou" },
        { word: "ÊòéÊó•", kana: "„ÅÇ„Åó„Åü", romaji: "ashita" },
        { word: "Êò®Êó•", kana: "„Åç„ÅÆ„ÅÜ", romaji: "kinou" },
        { word: "Â§©Ê∞ó", kana: "„Å¶„Çì„Åç", romaji: "tenki" },
        { word: "Èõ®", kana: "„ÅÇ„ÇÅ", romaji: "ame" },
        { word: "Ê∞¥", kana: "„Åø„Åö", romaji: "mizu" },
        { word: "„ÅäËå∂", kana: "„Åä„Å°„ÇÉ", romaji: "ocha" },
        { word: "„ÅîÈ£Ø", kana: "„Åî„ÅØ„Çì", romaji: "gohan" },
        { word: "„Éë„É≥", kana: "„Å±„Çì", romaji: "pan" },
        { word: "ËÇâ", kana: "„Å´„Åè", romaji: "niku" },
        { word: "È≠ö", kana: "„Åï„Åã„Å™", romaji: "sakana" },
        { word: "ÈáéËèú", kana: "„ÇÑ„Åï„ÅÑ", romaji: "yasai" },
        { word: "ÊûúÁâ©", kana: "„Åè„Å†„ÇÇ„ÅÆ", romaji: "kudamono" },
        
        // Food & Drink
        { word: "Áâõ‰π≥", kana: "„Åé„ÇÖ„ÅÜ„Å´„ÇÖ„ÅÜ", romaji: "gyuunyuu" },
        { word: "Âçµ", kana: "„Åü„Åæ„Åî", romaji: "tamago" },
        { word: "Êúù„ÅîÈ£Ø", kana: "„ÅÇ„Åï„Åî„ÅØ„Çì", romaji: "asagohan" },
        { word: "Êòº„ÅîÈ£Ø", kana: "„Å≤„Çã„Åî„ÅØ„Çì", romaji: "hirugohan" },
        { word: "Êô©„ÅîÈ£Ø", kana: "„Å∞„Çì„Åî„ÅØ„Çì", romaji: "bangohan" },
        { word: "„ÅäÂºÅÂΩì", kana: "„Åä„Åπ„Çì„Å®„ÅÜ", romaji: "obentou" },
        { word: "„ÅäËèìÂ≠ê", kana: "„Åä„Åã„Åó", romaji: "okashi" },
        { word: "Á†ÇÁ≥ñ", kana: "„Åï„Å®„ÅÜ", romaji: "satou" },
        { word: "Â°©", kana: "„Åó„Åä", romaji: "shio" },
        { word: "ÈÜ§Ê≤π", kana: "„Åó„Çá„ÅÜ„ÇÜ", romaji: "shouyu" },
        { word: "ÊñôÁêÜ", kana: "„Çä„Çá„ÅÜ„Çä", romaji: "ryouri" },
        { word: "ÁÆ∏", kana: "„ÅØ„Åó", romaji: "hashi" },
        { word: "Áöø", kana: "„Åï„Çâ", romaji: "sara" },
        { word: "„Ç≥„ÉÉ„Éó", kana: "„Åì„Å£„Å∑", romaji: "koppu" },

        // Body & Health
        { word: "È†≠", kana: "„ÅÇ„Åü„Åæ", romaji: "atama" },
        { word: "È°î", kana: "„Åã„Åä", romaji: "kao" },
        { word: "ÁõÆ", kana: "„ÇÅ", romaji: "me" },
        { word: "ËÄ≥", kana: "„Åø„Åø", romaji: "mimi" },
        { word: "Âè£", kana: "„Åè„Å°", romaji: "kuchi" },
        { word: "Èºª", kana: "„ÅØ„Å™", romaji: "hana" },
        { word: "Êâã", kana: "„Å¶", romaji: "te" },
        { word: "Ë∂≥", kana: "„ÅÇ„Åó", romaji: "ashi" },
        { word: "‰Ωì", kana: "„Åã„Çâ„Å†", romaji: "karada" },
        { word: "È´™", kana: "„Åã„Åø", romaji: "kami" },
        { word: "Êåá", kana: "„ÇÜ„Å≥", romaji: "yubi" },
        { word: "„ÅäËÖπ", kana: "„Åä„Å™„Åã", romaji: "onaka" },
        { word: "È¢®ÈÇ™", kana: "„Åã„Åú", romaji: "kaze" },
        { word: "Ëñ¨", kana: "„Åè„Åô„Çä", romaji: "kusuri" },
        { word: "ÁóÖÈô¢", kana: "„Å≥„Çá„ÅÜ„ÅÑ„Çì", romaji: "byouin" },

        // House & Daily
        { word: "ÁéÑÈñ¢", kana: "„Åí„Çì„Åã„Çì", romaji: "genkan" },
        { word: "Âè∞ÊâÄ", kana: "„Å†„ÅÑ„Å©„Åì„Çç", romaji: "daidokoro" },
        { word: "„ÅäÈ¢®ÂëÇ", kana: "„Åä„Åµ„Çç", romaji: "ofuro" },
        { word: "„Éà„Ç§„É¨", kana: "„Å®„ÅÑ„Çå", romaji: "toire" },
        { word: "Á™ì", kana: "„Åæ„Å©", romaji: "mado" },
        { word: "„Éâ„Ç¢", kana: "„Å©„ÅÇ", romaji: "doa" },
        { word: "Ê§ÖÂ≠ê", kana: "„ÅÑ„Åô", romaji: "isu" },
        { word: "Êú∫", kana: "„Å§„Åè„Åà", romaji: "tsukue" },
        { word: "ÊôÇË®à", kana: "„Å®„Åë„ÅÑ", romaji: "tokei" },
        { word: "ÂÇò", kana: "„Åã„Åï", romaji: "kasa" },
        { word: "ÈûÑ", kana: "„Åã„Å∞„Çì", romaji: "kaban" },
        { word: "Èù¥", kana: "„Åè„Å§", romaji: "kutsu" },
        { word: "Â∏ΩÂ≠ê", kana: "„Åº„ÅÜ„Åó", romaji: "boushi" },
        { word: "Ë≤°Â∏É", kana: "„Åï„ÅÑ„Åµ", romaji: "saifu" },
        { word: "Èçµ", kana: "„Åã„Åé", romaji: "kagi" },
        { word: "ÊâãÁ¥ô", kana: "„Å¶„Åå„Åø", romaji: "tegami" },
        { word: "ÂÜôÁúü", kana: "„Åó„ÇÉ„Åó„Çì", romaji: "shashin" },
        { word: "ËæûÊõ∏", kana: "„Åò„Åó„Çá", romaji: "jisho" },
        { word: "ÈâõÁ≠Ü", kana: "„Åà„Çì„Å¥„Å§", romaji: "enpitsu" },
        { word: "Êñ∞ËÅû", kana: "„Åó„Çì„Å∂„Çì", romaji: "shinbun" },
        { word: "ÁúºÈè°", kana: "„ÇÅ„Åå„Å≠", romaji: "megane" },
        { word: "Êúç", kana: "„Åµ„Åè", romaji: "fuku" },
        { word: "Ê¥óÊøØ", kana: "„Åõ„Çì„Åü„Åè", romaji: "sentaku" },
        { word: "ÊéÉÈô§", kana: "„Åù„ÅÜ„Åò", romaji: "souji" },
        { word: "Ë≤∑„ÅÑÁâ©", kana: "„Åã„ÅÑ„ÇÇ„ÅÆ", romaji: "kaimono" },

        // City & Places
        { word: "ÈßÖ", kana: "„Åà„Åç", romaji: "eki" },
        { word: "Á©∫Ê∏Ø", kana: "„Åè„ÅÜ„Åì„ÅÜ", romaji: "kuukou" },
        { word: "Âú∞‰∏ãÈâÑ", kana: "„Å°„Åã„Å¶„Å§", romaji: "chikatetsu" },
        { word: "„Éê„ÇπÂÅú", kana: "„Å∞„Åô„Å¶„ÅÑ", romaji: "basutei" },
        { word: "Âú∞Âõ≥", kana: "„Å°„Åö", romaji: "chizu" },
        { word: "ÈÅì", kana: "„Åø„Å°", romaji: "michi" },
        { word: "ÂÖ¨Âúí", kana: "„Åì„ÅÜ„Åà„Çì", romaji: "kouen" },
        { word: "Êò†ÁîªÈ§®", kana: "„Åà„ÅÑ„Åå„Åã„Çì", romaji: "eigakan" },
        { word: "Âõ≥Êõ∏È§®", kana: "„Å®„Åó„Çá„Åã„Çì", romaji: "toshokan" },
        { word: "ÁæéË°ìÈ§®", kana: "„Å≥„Åò„ÇÖ„Å§„Åã„Çì", romaji: "bijutsukan" },
        { word: "ÈÉµ‰æøÂ±Ä", kana: "„ÇÜ„ÅÜ„Å≥„Çì„Åç„Çá„Åè", romaji: "yuubinkyoku" },
        { word: "ÈäÄË°å", kana: "„Åé„Çì„Åì„ÅÜ", romaji: "ginkou" },
        { word: "Â∫ó", kana: "„Åø„Åõ", romaji: "mise" },
        { word: "‰∫§Áï™", kana: "„Åì„ÅÜ„Å∞„Çì", romaji: "kouban" },
        { word: "„Éõ„ÉÜ„É´", kana: "„Åª„Å¶„Çã", romaji: "hoteru" },

        // Nature & Season
        { word: "Êò•", kana: "„ÅØ„Çã", romaji: "haru" },
        { word: "Â§è", kana: "„Å™„Å§", romaji: "natsu" },
        { word: "Áßã", kana: "„ÅÇ„Åç", romaji: "aki" },
        { word: "ÂÜ¨", kana: "„Åµ„ÇÜ", romaji: "fuyu" },
        { word: "Èõ™", kana: "„ÇÜ„Åç", romaji: "yuki" },
        { word: "È¢®", kana: "„Åã„Åú", romaji: "kaze" },
        { word: "Êúà", kana: "„Å§„Åç", romaji: "tsuki" },
        { word: "Êòü", kana: "„Åª„Åó", romaji: "hoshi" },
        { word: "Â§™ÈôΩ", kana: "„Åü„ÅÑ„Çà„ÅÜ", romaji: "taiyou" },
        { word: "Ê±†", kana: "„ÅÑ„Åë", romaji: "ike" },
        { word: "Ê£Æ", kana: "„ÇÇ„Çä", romaji: "mori" },
        { word: "Êûó", kana: "„ÅØ„ÇÑ„Åó", romaji: "hayashi" },
        { word: "Áü≥", kana: "„ÅÑ„Åó", romaji: "ishi" },
        { word: "Ëô´", kana: "„ÇÄ„Åó", romaji: "mushi" },

        // Colors
        { word: "Ëµ§", kana: "„ÅÇ„Åã", romaji: "aka" },
        { word: "Èùí", kana: "„ÅÇ„Åä", romaji: "ao" },
        { word: "ÁôΩ", kana: "„Åó„Çç", romaji: "shiro" },
        { word: "Èªí", kana: "„Åè„Çç", romaji: "kuro" },
        { word: "ÈªÑËâ≤", kana: "„Åç„ÅÑ„Çç", romaji: "kiiro" },
        { word: "Á∑ë", kana: "„Åø„Å©„Çä", romaji: "midori" },
        { word: "Ëå∂Ëâ≤", kana: "„Å°„ÇÉ„ÅÑ„Çç", romaji: "chairo" },
        { word: "Ëâ≤", kana: "„ÅÑ„Çç", romaji: "iro" },

        // Directions & Positions
        { word: "‰∏ä", kana: "„ÅÜ„Åà", romaji: "ue" },
        { word: "‰∏ã", kana: "„Åó„Åü", romaji: "shita" },
        { word: "Âè≥", kana: "„Åø„Åé", romaji: "migi" },
        { word: "Â∑¶", kana: "„Å≤„Å†„Çä", romaji: "hidari" },
        { word: "Ââç", kana: "„Åæ„Åà", romaji: "mae" },
        { word: "Âæå„Çç", kana: "„ÅÜ„Åó„Çç", romaji: "ushiro" },
        { word: "‰∏≠", kana: "„Å™„Åã", romaji: "naka" },
        { word: "Â§ñ", kana: "„Åù„Å®", romaji: "soto" },
        { word: "Èö£", kana: "„Å®„Å™„Çä", romaji: "tonari" },
        { word: "Ëøë„Åè", kana: "„Å°„Åã„Åè", romaji: "chikaku" },
        { word: "ÈÅ†„Åè", kana: "„Å®„Åä„Åè", romaji: "tooku" },
        { word: "Êù±", kana: "„Å≤„Åå„Åó", romaji: "higashi" },
        { word: "Ë•ø", kana: "„Å´„Åó", romaji: "nishi" },
        { word: "Âçó", kana: "„Åø„Å™„Åø", romaji: "minami" },
        { word: "Âåó", kana: "„Åç„Åü", romaji: "kita" },

        // Nouns - Abstract & Society (Remaining)
        { word: "ÊÑèÂë≥", kana: "„ÅÑ„Åø", romaji: "imi" },
        { word: "ÂïèÈ°å", kana: "„ÇÇ„Çì„Å†„ÅÑ", romaji: "mondai" },
        { word: "Á≠î„Åà", kana: "„Åì„Åü„Åà", romaji: "kotae" },
        { word: "ÂêçÂâç", kana: "„Å™„Åæ„Åà", romaji: "namae" },
        { word: "Ë®ÄËëâ", kana: "„Åì„Å®„Å∞", romaji: "kotoba" },
        { word: "Ë≥™Âïè", kana: "„Åó„Å§„ÇÇ„Çì", romaji: "shitsumon" },
        { word: "ÁîüÊ¥ª", kana: "„Åõ„ÅÑ„Åã„Å§", romaji: "seikatsu" },
        { word: "‰∏ñÁïå", kana: "„Åõ„Åã„ÅÑ", romaji: "sekai" },
        { word: "Âπ≥Âíå", kana: "„Å∏„ÅÑ„Çè", romaji: "heiwa" },
        { word: "ÊÉÖÂ†±", kana: "„Åò„Çá„ÅÜ„Åª„ÅÜ", romaji: "jouhou" },
        { word: "ÁµåÊ∏à", kana: "„Åë„ÅÑ„Åñ„ÅÑ", romaji: "keizai" },
        { word: "ÊäÄË°ì", kana: "„Åé„Åò„ÇÖ„Å§", romaji: "gijutsu" },
        { word: "ÁµåÈ®ì", kana: "„Åë„ÅÑ„Åë„Çì", romaji: "keiken" },
        { word: "Ë®àÁîª", kana: "„Åë„ÅÑ„Åã„Åè", romaji: "keikaku" },
        { word: "Â§âÂåñ", kana: "„Å∏„Çì„Åã", romaji: "henka" },
        { word: "ÂøÖË¶Å", kana: "„Å≤„Å§„Çà„ÅÜ", romaji: "hitsuyou" },
        { word: "ÁêÜÁî±", kana: "„Çä„ÇÜ„ÅÜ", romaji: "riyuu" },
        { word: "Â§ß‰∫∫", kana: "„Åä„Å®„Å™", romaji: "otona" },
        { word: "Â≠ê‰æõ", kana: "„Åì„Å©„ÇÇ", romaji: "kodomo" },
        { word: "Áî∑", kana: "„Åä„Å®„Åì", romaji: "otoko" },
        { word: "Â•≥", kana: "„Åä„Çì„Å™", romaji: "onna" },
        { word: "‰∫∫", kana: "„Å≤„Å®", romaji: "hito" },
        
        // Nature & Animals (Remaining)
        { word: "Áå´", kana: "„Å≠„Åì", romaji: "neko" },
        { word: "Áä¨", kana: "„ÅÑ„Å¨", romaji: "inu" },
        { word: "È≥•", kana: "„Å®„Çä", romaji: "tori" },
        { word: "Êµ∑", kana: "„ÅÜ„Åø", romaji: "umi" },
        { word: "Â±±", kana: "„ÇÑ„Åæ", romaji: "yama" },
        { word: "Â∑ù", kana: "„Åã„Çè", romaji: "kawa" },
        { word: "Á©∫", kana: "„Åù„Çâ", romaji: "sora" },
        { word: "Ëä±", kana: "„ÅØ„Å™", romaji: "hana" },
        { word: "Êú®", kana: "„Åç", romaji: "ki" },
        
        // Advanced / Business (Remaining)
        { word: "Á¢∫Ë™ç", kana: "„Åã„Åè„Å´„Çì", romaji: "kakunin" },
        { word: "ÈÄ£Áµ°", kana: "„Çå„Çì„Çâ„Åè", romaji: "renraku" },
        { word: "Â†±Âëä", kana: "„Åª„ÅÜ„Åì„Åè", romaji: "houkoku" },
        { word: "Áõ∏Ë´á", kana: "„Åù„ÅÜ„Å†„Çì", romaji: "soudan" },
        { word: "ÊàêÂäü", kana: "„Åõ„ÅÑ„Åì„ÅÜ", romaji: "seikou" },
        { word: "Â§±Êïó", kana: "„Åó„Å£„Å±„ÅÑ", romaji: "shippai" },
        { word: "ÁõÆÊ®ô", kana: "„ÇÇ„Åè„Å≤„Çá„ÅÜ", romaji: "mokuhyou" },
        { word: "ÁµêÊûú", kana: "„Åë„Å£„Åã", romaji: "kekka" },
        { word: "Ê∫ñÂÇô", kana: "„Åò„ÇÖ„Çì„Å≥", romaji: "junbi" },
        { word: "‰∫àÁ¥Ñ", kana: "„Çà„ÇÑ„Åè", romaji: "yoyaku" },
        { word: "Á¥ÑÊùü", kana: "„ÇÑ„Åè„Åù„Åè", romaji: "yakusoku" },
        { word: "Âá∫Áô∫", kana: "„Åó„ÇÖ„Å£„Å±„Å§", romaji: "shuppatsu" },
        { word: "Âà∞ÁùÄ", kana: "„Å®„ÅÜ„Å°„ÇÉ„Åè", romaji: "touchaku" }
    ];

    // --- Romaji Logic & Data ---
    const romajiTable = {
        '„ÅÇ': ['a'], '„ÅÑ': ['i', 'yi'], '„ÅÜ': ['u', 'wu', 'whu'], '„Åà': ['e'], '„Åä': ['o'],
        '„Åã': ['ka', 'ca'], '„Åç': ['ki'], '„Åè': ['ku', 'cu', 'qu'], '„Åë': ['ke'], '„Åì': ['ko', 'co'],
        '„Åï': ['sa'], '„Åó': ['shi', 'si', 'ci'], '„Åô': ['su'], '„Åõ': ['se', 'ce'], '„Åù': ['so'],
        '„Åü': ['ta'], '„Å°': ['chi', 'ti'], '„Å§': ['tsu', 'tu'], '„Å¶': ['te'], '„Å®': ['to'],
        '„Å™': ['na'], '„Å´': ['ni'], '„Å¨': ['nu'], '„Å≠': ['ne'], '„ÅÆ': ['no'],
        '„ÅØ': ['ha', 'wa'], '„Å≤': ['hi'], '„Åµ': ['fu', 'hu'], '„Å∏': ['he'], '„Åª': ['ho'],
        '„Åæ': ['ma'], '„Åø': ['mi'], '„ÇÄ': ['mu'], '„ÇÅ': ['me'], '„ÇÇ': ['mo'],
        '„ÇÑ': ['ya'], '„ÇÜ': ['yu'], '„Çà': ['yo'],
        '„Çâ': ['ra'], '„Çä': ['ri'], '„Çã': ['ru'], '„Çå': ['re'], '„Çç': ['ro'],
        '„Çè': ['wa'], '„Çí': ['wo'], '„Çì': ['nn', 'xn', "n'"],
        '„Åå': ['ga'], '„Åé': ['gi'], '„Åê': ['gu'], '„Åí': ['ge'], '„Åî': ['go'],
        '„Åñ': ['za'], '„Åò': ['ji', 'zi'], '„Åö': ['zu'], '„Åú': ['ze'], '„Åû': ['zo'],
        '„Å†': ['da'], '„Å¢': ['ji', 'di'], '„Å•': ['zu', 'du'], '„Åß': ['de'], '„Å©': ['do'],
        '„Å∞': ['ba'], '„Å≥': ['bi'], '„Å∂': ['bu'], '„Åπ': ['be'], '„Åº': ['bo'],
        '„Å±': ['pa'], '„Å¥': ['pi'], '„Å∑': ['pu'], '„Å∫': ['pe'], '„ÅΩ': ['po'],
        '„ÅÅ': ['xa', 'la'], '„ÅÉ': ['xi', 'li'], '„ÅÖ': ['xu', 'lu'], '„Åá': ['xe', 'le'], '„Åâ': ['xo', 'lo'],
        '„ÇÉ': ['xya', 'lya'], '„ÇÖ': ['xyu', 'lyu'], '„Çá': ['xyo', 'lyo'],
        '„Å£': ['xtsu', 'ltsu'],
        '„Éº': ['-'],
        // Compounds (Youon)
        '„Åç„ÇÉ': ['kya'], '„Åç„ÇÖ': ['kyu'], '„Åç„Çá': ['kyo'],
        '„Åó„ÇÉ': ['sha', 'sya'], '„Åó„ÇÖ': ['shu', 'syu'], '„Åó„Çá': ['sho', 'syo'],
        '„Å°„ÇÉ': ['cha', 'tya'], '„Å°„ÇÖ': ['chu', 'tyu'], '„Å°„Çá': ['cho', 'tyo'],
        '„Å´„ÇÉ': ['nya'], '„Å´„ÇÖ': ['nyu'], '„Å´„Çá': ['nyo'],
        '„Å≤„ÇÉ': ['hya'], '„Å≤„ÇÖ': ['hyu'], '„Å≤„Çá': ['hyo'],
        '„Åø„ÇÉ': ['mya'], '„Åø„ÇÖ': ['myu'], '„Åø„Çá': ['myo'],
        '„Çä„ÇÉ': ['rya'], '„Çä„ÇÖ': ['ryu'], '„Çä„Çá': ['ryo'],
        '„Åé„ÇÉ': ['gya'], '„Åé„ÇÖ': ['gyu'], '„Åé„Çá': ['gyo'],
        '„Åò„ÇÉ': ['ja', 'jya', 'zya'], '„Åò„ÇÖ': ['ju', 'jyu', 'zyu'], '„Åò„Çá': ['jo', 'jyo', 'zyo'],
        '„Å¢„ÇÉ': ['dya', 'ja'], '„Å¢„ÇÖ': ['dyu', 'ju'], '„Å¢„Çá': ['dyo', 'jo'],
        '„Å≥„ÇÉ': ['bya'], '„Å≥„ÇÖ': ['byu'], '„Å≥„Çá': ['byo'],
        '„Å¥„ÇÉ': ['pya'], '„Å¥„ÇÖ': ['pyu'], '„Å¥„Çá': ['pyo'],
        // Special particles context (simplified)
        '„Çí': ['wo']
    };

    // Game Variables
    let currentWordIndex = 0;
    let score = 0;
    let correctChars = 0;
    let missChars = 0;
    let timeLeft = 90;
    let timerInterval;
    let isPlaying = false;
    let shuffledWords = [];

    // Token Logic Variables
    let gameTokens = []; 
    let currentTokenIndex = 0;
    let currentInputBuffer = ""; // Partial input for the current token

    // DOM Elements
    const screens = {
        start: document.getElementById('start-screen'),
        game: document.getElementById('game-screen'),
        result: document.getElementById('result-screen')
    };
    const display = {
        kanji: document.getElementById('display-kanji'),
        kana: document.getElementById('display-kana'),
        romaji: document.getElementById('display-romaji'),
        timer: document.getElementById('timer'),
        score: document.getElementById('score')
    };
    const resultDisplay = {
        score: document.getElementById('final-score'),
        correct: document.getElementById('res-correct'),
        miss: document.getElementById('res-miss'),
        wpm: document.getElementById('res-wpm'),
        form: document.getElementById('new-record-form'),
        input: document.getElementById('player-name')
    };

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        try {
            initRanking();
        } catch (e) {
            console.error("Ranking init failed:", e);
            document.getElementById('top-ranking').innerHTML = '<p>Ranking unavailable (Offline)</p>';
        }

        // Event Listeners
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('retry-btn').addEventListener('click', startGame);
        document.getElementById('home-btn').addEventListener('click', showStartScreen);
        document.getElementById('save-rank-btn').addEventListener('click', saveScore);
    });
    
    // Main Game Input
    window.addEventListener('keydown', (e) => {
        if (!isPlaying) return;
        
        // Ignore modifier keys
        if (e.key.length > 1) return;

        // Prevent space scrolling etc.
        if(e.key === " ") e.preventDefault();

        handleInput(e.key);
    });

    function showScreen(screenName) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[screenName].classList.add('active');
    }

    function showStartScreen() {
        showScreen('start');
        updateRankingDisplay();
    }

    function startGame() {
        // Reset Variables
        score = 0;
        correctChars = 0;
        missChars = 0;
        timeLeft = 90;
        isPlaying = true;

        // Shuffle Words
        shuffledWords = [...wordList].sort(() => Math.random() - 0.5);
        currentWordIndex = 0;

        // Update UI
        display.score.textContent = `Score: ${score}`;
        display.timer.textContent = `Time: ${timeLeft}`;
        resultDisplay.form.style.display = 'none';

        setWord();
        showScreen('game');

        // Start Timer
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            display.timer.textContent = `Time: ${timeLeft}`;
            if (timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    function setWord() {
        if (currentWordIndex >= shuffledWords.length) {
            shuffledWords = [...wordList].sort(() => Math.random() - 0.5);
            currentWordIndex = 0;
        }

        const wordData = shuffledWords[currentWordIndex];
        
        // Parse Kana to Tokens
        gameTokens = parseKanaToTokens(wordData.kana);
        currentTokenIndex = 0;
        currentInputBuffer = "";

        display.kanji.textContent = wordData.word;
        display.kana.textContent = wordData.kana;
        renderRomaji();
    }

    function parseKanaToTokens(kanaString) {
        const tokens = [];
        let i = 0;
        while (i < kanaString.length) {
            let token = null;
            let char2 = kanaString.substring(i, i + 2);
            let char1 = kanaString.substring(i, i + 1);

            // 1. Try 2-char compound (Youon) first
            if (romajiTable[char2]) {
                token = { 
                    kana: char2, 
                    patterns: [...romajiTable[char2]], // copy
                    input: null 
                };
                i += 2;
            } else {
                // 2. Single char
                let patterns = romajiTable[char1] ? [...romajiTable[char1]] : ['?'];
                token = { 
                    kana: char1, 
                    patterns: patterns,
                    input: null
                };
                i += 1;
            }
            tokens.push(token);
        }

        // Post-processing for '„Å£' (Sokuon) and '„Çì' (N)
        for (let j = 0; j < tokens.length; j++) {
            const t = tokens[j];
            const nextT = tokens[j + 1];

            // Special handling for Sokuon '„Å£'
            if (t.kana === '„Å£' && nextT) {
                // Add the first char of valid patterns of the next token
                // e.g. next is 'ka', add 'k' to '„Å£' patterns
                const nextFirstChars = new Set();
                nextT.patterns.forEach(p => {
                    if (p.length > 0) nextFirstChars.add(p[0]);
                });
                t.patterns.push(...nextFirstChars);
            }

            // Optional: '„Çì' usually requires 'nn', but 'n' is allowed if next is not vowel/n/y etc.
            // For simplicity in this game, we stick to explicit inputs or 'n'+next consonant logic if we wanted.
            // Current table has 'nn', 'xn', "n'". "n" single usage is complex (e.g. kani -> ka, ni vs kan, i).
            // We leave '„Çì' as 'nn' primarily.
        }

        return tokens;
    }

    function renderRomaji(isError = false) {
        let html = '';

        gameTokens.forEach((token, idx) => {
            if (idx < currentTokenIndex) {
                // Completed tokens
                html += `<span class="typed">${token.input}</span>`;
            } else if (idx === currentTokenIndex) {
                // Current token logic
                // Show what user typed so far (buffer) + hint of remaining chars from the SHORTEST matching pattern
                const validPatterns = token.patterns.filter(p => p.startsWith(currentInputBuffer));
                // Sort by length to show the shortest completion hint
                validPatterns.sort((a, b) => a.length - b.length);
                
                const bestMatch = validPatterns[0] || token.patterns[0]; // fallback
                const remaining = bestMatch.substring(currentInputBuffer.length);

                html += `<span class="typed">${currentInputBuffer}</span>`;
                html += `<span class="current ${isError ? 'error' : ''}">${remaining}</span>`;
            } else {
                // Future tokens
                // Just show the first pattern as default hint
                html += `<span>${token.patterns[0]}</span>`;
            }
        });

        display.romaji.innerHTML = html;
        
        if (isError) {
            setTimeout(() => {
                const currentSpan = display.romaji.querySelector('.current.error');
                if (currentSpan) currentSpan.classList.remove('error');
            }, 300);
        }
    }

    function handleInput(key) {
        key = key.toLowerCase();
        
        // Current active token
        const token = gameTokens[currentTokenIndex];
        const nextBuffer = currentInputBuffer + key;

        // Filter patterns that match the new buffer
        const matchingPatterns = token.patterns.filter(p => p.startsWith(nextBuffer));

        if (matchingPatterns.length > 0) {
            // Valid Input
            currentInputBuffer = nextBuffer;
            correctChars++;
            score += 10;
            
            // Check if token is complete (Exact match with one of the patterns)
            const exactMatch = matchingPatterns.find(p => p === currentInputBuffer);
            if (exactMatch) {
                token.input = currentInputBuffer; // save what user actually typed
                currentTokenIndex++;
                currentInputBuffer = ""; // Reset buffer for next token
            }

            // Check Word Completion
            if (currentTokenIndex >= gameTokens.length) {
                score += 50;
                currentWordIndex++;
                setWord();
            } else {
                renderRomaji();
            }

        } else {
            // Miss
            missChars++;
            score = Math.max(0, score - 5);
            renderRomaji(true);
        }
        display.score.textContent = `Score: ${score}`;
    }

    function endGame() {
        isPlaying = false;
        clearInterval(timerInterval);
        showScreen('result');

        const wpm = Math.floor(correctChars / 5);

        resultDisplay.score.textContent = score;
        resultDisplay.correct.textContent = correctChars;
        resultDisplay.miss.textContent = missChars;
        resultDisplay.wpm.textContent = wpm;

        checkRanking(score);
    }

    // --- Ranking System ---
    const STORAGE_KEY = 'typing_app_ranking_v1';
    let ranking = [];

    function initRanking() {
        let saved = null;
        try {
            saved = localStorage.getItem(STORAGE_KEY);
        } catch (e) {
            console.warn("LocalStorage not available:", e);
        }

        if (saved) {
            ranking = JSON.parse(saved);
        } else {
            // Default ranking
            ranking = [
                { name: "MASTER", score: 2000, date: getDateString() },
                { name: "EXPERT", score: 1500, date: getDateString() },
                { name: "PRO", score: 1000, date: getDateString() },
                { name: "ROOKIE", score: 500, date: getDateString() },
                { name: "BEGINNER", score: 100, date: getDateString() }
            ];
            // Only try saving if we think it might work, or just let it fail silently in saveRankingData
            saveRankingData();
        }
        updateRankingDisplay();
    }

    function checkRanking(currentScore) {
        // Sort current ranking just in case
        ranking.sort((a, b) => b.score - a.score);
        
        // Check if score is higher than the 5th place
        if (ranking.length < 5 || currentScore > ranking[ranking.length - 1].score) {
            resultDisplay.form.style.display = 'block';
            resultDisplay.input.value = '';
            resultDisplay.input.focus();
        } else {
            resultDisplay.form.style.display = 'none';
        }
    }

    function saveScore() {
        const name = resultDisplay.input.value.trim() || "Anonymous";
        const newEntry = {
            name: name,
            score: score,
            date: getDateString()
        };

        ranking.push(newEntry);
        ranking.sort((a, b) => b.score - a.score);
        ranking = ranking.slice(0, 5); // Keep top 5

        saveRankingData();
        
        resultDisplay.form.style.display = 'none';
        alert("Score Saved!");
        showStartScreen(); // Go back to start to see ranking
    }

    function saveRankingData() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(ranking));
        } catch (e) {
            console.warn("Could not save to LocalStorage:", e);
        }
    }

    function updateRankingDisplay() {
        const container = document.getElementById('top-ranking');
        container.innerHTML = '<h3>üèÜ TOP 5 RANKING üèÜ</h3>';
        
        ranking.forEach((entry, index) => {
            const div = document.createElement('div');
            div.className = 'ranking-item';
            div.innerHTML = `
                <span class="ranking-rank">${index + 1}.</span>
                <span class="ranking-name">${entry.name}</span>
                <span class="ranking-score">${entry.score} pts</span>
            `;
            container.appendChild(div);
        });
    }

    function getDateString() {
        const d = new Date();
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    }

</script>
</body>
</html>
